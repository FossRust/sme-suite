name: "AuthN (OIDC BFF): multi-provider login, session cookie, Query.me"
read_first:
  - "/codex/prompts/header.md"
  - "/server/src/main.rs"
  - "/platform/db/src/lib.rs"
acceptance:
  - "Implement generic OIDC (code+PKCE) with multiple providers (by issuer) configured via env/config"
  - "Routes: GET /login?provider=ID, GET /oidc/callback/:provider"
  - "On callback: validate ID token via JWKS; upsert user by email; ensure membership in a default org (create if first user)"
  - "Set HttpOnly, Secure session cookie (SameSite=Lax ok for now) carrying a signed session (no server-side store)"
  - "Per request: verify session cookie, build `ReqCtx{user_id, org_id}`; set Postgres `SET LOCAL app.tenant_id`"
  - "GraphQL `me`: { id, email, name, org { id, slug, name }, roles, entitlements[] }"
  - "Add logout route to clear cookie"
  - "CORS configured to allow SPA origin(s) from env"
constraints:
  - "Use `openidconnect` crate, `reqwest` rustls, cache JWKS per issuer with TTL"
  - "Cookie value must be signed & AEAD-encrypted (e.g., cookie-private key via `cookie` + `ring`/`orion`); do not store raw tokens"
  - "Do not expose ID/Access tokens to the client"
  - "No extra services; no Redis"
plan:
  - "Create platform/authn with OIDC client registry (issuer -> client), PKCE helper, nonce/state storage in signed temp cookie"
  - "Add login & callback handlers; map claims (sub,email,name)"
  - "Upsert user + ensure membership; if no org exists, create 'primary' org and grant admin"
  - "Implement `SessionLayer` (Tower) to verify cookie and place ReqCtx in extensions; tie to DB tenant setter"
  - "Protect GraphQL with session required; allow /health, /login, /oidc/callback public"
  - "Implement Query.me resolver (uses ReqCtx + DB joins)"
run:
  - "apply_patch: add platform/authn crate and server routes/resolvers"
  - "shell: cargo fmt && cargo clippy -D warnings && cargo test"
  - "shell: DATABASE_URL=... OIDC_...=... cargo run -p server -- serve & sleep 1 && curl -I http://localhost:8080/health"
tools: ["apply_patch", "shell", "git"]
diff_expectations:
  - "/platform/authn/Cargo.toml"
  - "/platform/authn/src/lib.rs"
  - "/server/src/http.rs"             # /login, /oidc/callback, /logout
  - "/server/src/middleware/session.rs"
  - "/server/src/graphql/me.rs"
  - "/server/src/graphql/mod.rs"      # wire Query.me
  - "/server/src/config.rs"           # load providers, cookie secrets, cors
  - "/.env.example"                   # OIDC and cookie secrets
notes:
  - "Support multiple providers: AUTH_PROVIDERS='auth0,keycloak,cognito'; each with {ISSUER, CLIENT_ID, CLIENT_SECRET, REDIRECT_URL}"
  - "Fallback default org from `DEFAULT_ORG_SLUG` if provided; else auto-create on first login"
  - "Add minimal tests for cookie signing/verification and me query (happy path)"

