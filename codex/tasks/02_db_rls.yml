name: "DB & RLS: sqlx pool, migrations, tenant enforcement"
read_first:
  - "/codex/prompts/header.md"
  - "/server/src/main.rs"
  - "/platform/db/src/lib.rs"
acceptance:
  - "Add sqlx Postgres pool with rustls; connect at startup with health check"
  - "Create /sql/migrations/ with baseline and up/down scripts"
  - "Baseline schema: tenants(orgs), users, memberships, entitlements, audit_log"
  - "RLS: enable and enforce tenant scoping via `SET LOCAL app.tenant_id`"
  - "Helper in platform/db: `with_tenant(&Pool, org: Uuid) -> Conn` that sets GUC"
  - "Add CLI: `server migrate` (up/down) using sqlx::migrate!"
  - "Integration tests: create org A/B, insert sample rows, assert RLS hides cross-tenant data"
  - "Health endpoint now checks DB connectivity (returns ok:false on failure)"
constraints:
  - "No unsafe; avoid unwrap in DB paths"
  - "Use `uuid` type; prefer timestamptz; created_at default now()"
  - "Users table: id, email unique, name; Orgs: id, slug unique, name"
  - "Memberships: (org_id,user_id,role) unique; index for queries"
plan:
  - "Add sqlx dep and pool wiring; config via env: DATABASE_URL"
  - "Implement migrations: 0001_init.sql creates tables and RLS policies"
  - "Implement `set_local_tenant(conn, org_id)` helper"
  - "Wire DB pool into Axum state; /health shows db_ok"
  - "Add tests using `testcontainers` Postgres"
run:
  - "apply_patch: add migrations and code"
  - "shell: cargo fmt && cargo clippy -D warnings && cargo test && DATABASE_URL=postgres://... sqlx migrate info || true"
tools: ["apply_patch", "shell", "git"]
diff_expectations:
  - "/server/src/http.rs"            # inject db in state and health check
  - "/server/src/main.rs"            # load DATABASE_URL, init pool
  - "/platform/db/src/lib.rs"        # Pool type, helpers, with_tenant
  - "/sql/migrations/0001_init.sql"  # tables + RLS policies
  - "/tests/rls_isolation.rs"        # integration test
notes:
  - "RLS policy pattern: current_setting('app.tenant_id', true)::uuid"
  - "Add `SET LOCAL` in a connection wrapper used per request"

