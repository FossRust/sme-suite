name: "Scaffold: single binary (CLI + HTTP + GraphQL shell)"
read_first:
  - "/Cargo.toml"
  - "/codex/prompts/header.md"
acceptance:
  - "Create workspace with members: server, platform/db, platform/api, platform/obs"
  - "Binary `server` provides CLI: serve|migrate|seed|schema:print|apq:gen (stub impl for last two)"
  - "HTTP endpoints: GET /health -> 200 OK (json), POST /graphql -> empty QueryRoot works"
  - "GraphQL: QueryRoot has fields: health, me (returns null placeholder), version"
  - "Tracing + request-id middleware; graceful shutdown (SIGINT/SIGTERM)"
  - "CI workflow added: fmt, clippy, build, test; all passing"
  - "Commands: `cargo run -p server -- serve --port 8080` serves /health and /graphql"
constraints:
  - "Pin crate versions per header.md; use rustls, no native-tls"
  - "No warnings: clippy -D warnings must pass"
  - "Add basic unit test for /health and GraphQL /health resolver"
plan:
  - "Create root Cargo.toml (workspace) and each crate Cargo.toml"
  - "Implement platform/obs with tracing init and OTLP optional exporter"
  - "Implement platform/api with GraphQL helpers (error map, Result alias)"
  - "Implement platform/db stub (pool type only; real connect in Task 02)"
  - "Server main: Clap subcommands, Axum router, /health route, /graphql route with async-graphql schema (empty resolvers)"
  - "Add .github/workflows/ci.yml with fmt/clippy/build/test"
run:
  - "apply_patch: add files and content per plan"
  - "shell: cargo fmt && cargo clippy -D warnings && cargo test && cargo run -p server -- serve --port 8081 & sleep 1 && curl -sSf http://localhost:8081/health"
tools: ["apply_patch", "shell", "git"]
diff_expectations:
  - "/Cargo.toml"
  - "/server/Cargo.toml"
  - "/server/src/main.rs"
  - "/server/src/http.rs"
  - "/server/src/graphql/mod.rs"
  - "/platform/obs/Cargo.toml"
  - "/platform/obs/src/lib.rs"
  - "/platform/api/Cargo.toml"
  - "/platform/api/src/lib.rs"
  - "/platform/db/Cargo.toml"
  - "/platform/db/src/lib.rs"
  - "/.github/workflows/ci.yml"
notes:
  - "GraphQL Query.health should return { ok: true }"
  - "Schema printing command can be a stub returning file not found (will implement later)"

